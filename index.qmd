---
title: "IMPRINT"
author: "Sylvain Schmitt, Erwan Hingant, Jonathan Lenoir"
date: last-modified
format: 
  html:
    embed-resources: true
    toc: true
    code-fold: true
bibliography: references.bib
---

```{r set}
#| message: false
# devtools::install_github("sylvainschmitt/miroclimr")
library(tidyverse)
library(dataverse)
library(microclimr)
```

## Data

We downloaded back the data from the IMPRINT project [@gril2024] using the INDORES dataverse and the R dataverse package. Additionally macroclimatic data were retrieved from ERA5-Land [@muñoz-sabater2021] using the Google Earth Engine (`data/get_era.py` script) or shared from ONF by Erwan Hingant (pers. com.).

```{r dataverse}
#| eval: false
plots <- list(
  Aigoual = "10.48579/PRO/RSBT3C/VDNSLZ",
  Blois = "10.48579/PRO/RSBT3C/37MKWL",
  Mormal = "10.48579/PRO/RSBT3C/IJAKFT"
) %>% lapply(get_dataframe_by_doi, server = "data.indores.fr") %>% 
  bind_rows(.id = "site")
write_tsv(plots, "data/plots.tsv")
plots %>% 
  group_by(site) %>% 
  summarise(lon = mean(longwgs84), lat = mean(latwgs84)) %>% 
  write_tsv("data/coords.tsv")
temperatures <- list(
  Aigoual = "10.48579/PRO/ZQBQUW/MK2F35",
  Blois = "10.48579/PRO/ZQBQUW/ZL0LOC",
  Mormal = "10.48579/PRO/ZQBQUW/GBVNRR"
) %>% lapply(get_dataframe_by_doi, server = "data.indores.fr") %>% 
  bind_rows(.id = "site")
write_tsv(temperatures, "data/hobo.tsv")
lidar <- list(
  Aigoual = "10.48579/PRO/XH62TC/P4F7FP",
  Blois = "10.48579/PRO/XH62TC/OI6WQU",
  Mormal = "10.48579/PRO/XH62TC/5RXUGU"
) %>% lapply(get_dataframe_by_doi, server = "data.indores.fr") %>% 
  bind_rows(.id = "site")
write_tsv(lidar, "data/lidar.tsv")
lidar_sub <- lidar %>% 
  filter(buffer == 5) %>% 
  rename(plot = idplot) %>% 
  select(site, plot, pai)
era <- read_tsv("data/era.tsv") %>% 
  mutate(site = recode(dim_0, "0" = "Aigoual", "1" = "Blois", "2" = "Mormal")) %>% 
  mutate(datetime = as_datetime(time)) %>% 
  rename(era = tas) %>% 
  select(site, datetime, era)
onf <- list.files("data/methor_data_onf/", pattern = ".txt", full.names = TRUE) %>% 
  vroom::vroom(col_names = read_tsv("data/methor_data_onf/MetHor2018.org") %>% 
                 names()) %>% 
  select("Code placette",
         "Date",
         "Heure (TU)",
         "Température instantanée (°C)") %>% 
  mutate(datetime = paste0(str_sub(Date, 7, 10), "-",
                           str_sub(Date, 4, 5), "-",
                           str_sub(Date, 1, 2), " ",
                           str_sub(`Heure (TU)`, 1, 2), ":",
                           str_sub(`Heure (TU)`, 3, 4), ":00")) %>% 
  mutate(datetime = as_datetime(datetime)) %>% 
  rename(onf = "Température instantanée (°C)", plot = "Code placette") %>% 
  filter(plot %in% c("CHP 59", "CHS 41", "HET 30")) %>% 
  mutate(site = recode(plot, "CHP 59" = "Mormal",
                       "CHS 41" = "Blois", "HET 30" = "Aigoual")) %>% 
  select(site, datetime, onf) %>% 
  mutate(onf = gsub(",", ".", onf)) %>% 
  mutate(onf = as.numeric(onf))
data <- temperatures %>% 
  mutate(datetime = as_datetime(datetime)) %>% 
  rename(hobo = t_hobo, plot = id_plot, sensor = id_sensor,
         position = position_sensor) %>% 
  mutate(position = recode(position, "a" = "air", "s" = "soil")) %>% 
  select(site, plot, sensor, position, datetime, hobo) %>% 
  left_join(era) %>% 
  left_join(onf) %>% 
  left_join(lidar_sub)
write_tsv(data, "data/data.tsv")
```

## Macroclimate

First, we compared the macroclimate data from ONF local stations with the ERA5-Land reanalysis. Despite an overestimation of low temperatures in ERA5-Land, especially in Aigoual, and a slight underestimation of very high temperatures in Mormal, they show high similarity.

```{r macroclimate}
#| message: false
#| warning: false
#| eval: false
g <- read_tsv("data/data.tsv") %>% 
  filter(position == "air") %>% 
  filter(month(datetime) %in% 5:9) %>% 
  ggplot(aes(onf, era)) +
  geom_point(alpha = .5, col = "lightgrey") +
  geom_abline() +
  geom_smooth(methode = "lm", se = FALSE) +
  facet_wrap( ~ site) +
  theme_bw() +
  xlab("ONF weather station Temperature [°C]") +
  ylab("ERA5-Land Temperature [°C]")
ggsave("fig1.png", g)
```

```{r macro_fig}
#| fig-cap: Macroclimatic temperature of ONF weather stations against ERA5-Land reanalysis. The black line represents the 1:1 line and the blue line a smoothing.
knitr::include_graphics("fig1.png")
```

## Decomposition

We decomposed all the temperature series for ERA5-Land and HOBOs in May to September for each plot and sensor on 5 days window sliding of 3 days using a single call to `microclimr::fft_roll` (ca. 2 minute):

```{r decomposition}
#| eval: false
data <- read_tsv("data/data.tsv")
fc <- data %>%
  filter(month(datetime) %in% 5:9) %>% 
  gather(source, temperature,
         -site, -plot, -sensor, -position, -datetime, -pai) %>% 
  group_by(source, site, plot, sensor, position, pai,
           datetime = floor_date(datetime, "2 hour")) %>%
  summarise(temperature = mean(temperature)) %>% 
    group_by(source, site, plot, sensor, position, pai) %>%
  do(fft = fft_roll(
    data = .,
    t = 5*12,
    index_col = "datetime",
    temperature_col = "temperature",
    window = "5 days",
    step = "3 days"
  )) %>%
  unnest(fft)
write_tsv(fc, "data/decomposition.tsv")
```

> We summarised the temperature data at a frequency of two hours to homogenise soil and air temperature sensors, but we could use different time frequencies in the future.

We then computed a semi-lognormal power spectrum for air temperatures, using HOBO microclimate temperatures and ERA5-Land and ONF macroclimate temperatures, for the locations of Aigoual, Blois and Mormal. The power spectrum revealed higher power at periods 0 and 24-hr for the ERA5-Land data reanalysis compared to the ONF weather stations, which could bias buffer estimates.

```{r power_spectrum}
#| message: false
#| warning: false
#| fig-cap: Power spectrum for air and soil temperatures, using HOBO microclimate temperatures and ERA5-Land and ONF macroclimate temperatures, for the locations of Aigoual, Blois and Mormal
t <- "data/decomposition.tsv" %>% 
  read_tsv() %>% 
  group_by(source, site,  position, frequency, period) %>% 
  summarise(sd = sd(power, na.rm = TRUE),
            power = mean(power, na.rm = TRUE)) %>% 
  mutate(type = ifelse(source == "hobo", "Micro", "Macro")) %>% 
  mutate(source = recode(source,
                         "era" = "ERA5-Land",
                         "onf" = "ONF weather station",
                         "hobo" = paste("HOBO", position))) %>% 
  filter(!(type == "Macro" && position == "soil"))
t %>% 
  filter(period != 0) %>% 
  ggplot(aes(frequency, power)) +
  geom_col(fill = "darkgrey") +
  geom_linerange(aes(ymin = power-sd, ymax = power+sd)) +
  theme_bw() +
  xlab("Period [h]") +
  ylab("Power") +
  scale_x_continuous(
    breaks = c(1/120*2, 1 / 24*2, 1 / 12*2, 1 / 8*2, 1 / 6*2, 1 / 3*2),
    labels = c("5d", "24", "12", "8", "6", "3")
  ) +
  theme(legend.position.inside = c(0.8, 0.8)) +
  facet_grid(site ~ paste0(type, "\n", source)) +
  geom_text(x = 1/3, y = 6,
            aes(label = paste0("Mean: ", round(power), "±", round(sd))), 
            data = filter(t, period ==0))
```

## Buffer

We then computed the amplitude buffer backwards over a 24-hour period. We look only at sensors with at least 2/3 of expected windows (160). Using ONF macroclimate data, we observed a significant negative temperature amplitude buffer at Blois and Mormal, but not with ERA5-Land macroclimate reanalysis.

```{r buffer_nobs}
#| message: false
#| warning: false
#| fig-cap: Number of windows with available data for 5-days windows sliding on 3 days between May and September from 2020 to 2023 for air and soil sensors in the Mormal, Blois and Aigoual forests, for ONF and ERA5-Land macroclimate data.
buffers <- read_tsv("data/decomposition.tsv") %>% 
  filter(period == 12) %>% 
  select(source, site, plot, sensor, position, pai, power, datetime) %>% 
  pivot_wider(names_from = source, values_from = power) %>% 
  mutate(ratio_era = hobo/era, ratio_onf = hobo/onf) %>% 
  select(-era, -hobo, -onf) %>% 
  gather(source, ratio, -site, -plot, -sensor, -pai, -datetime, -position) %>% 
  mutate(source = gsub("ratio_", "", source))
buffers %>% 
  mutate(source = recode(source,
                         "era" = "ERA5-Land",
                         "onf" = "ONF weather station")) %>% 
  group_by(plot, position, source) %>% 
  summarise(nobs = n()) %>% 
  ggplot(aes(nobs)) +
  geom_histogram(fill = "lightgrey") +
  facet_grid(position ~ source) +
  theme_bw() +
  geom_vline(xintercept = 107) +
  xlab("Number of windows")
```

```{r buffer}
#| message: false
#| warning: false
#| fig-cap: The amplitude ratio for the 24-hour period between May and September from 2020 to 2023 for air and soil sensors in the Mormal, Blois and Aigoual forests, for ONF and ERA5-Land macroclimate data.
buffers %>% 
  group_by(plot, position, source) %>% 
  filter(n() > 107) %>%
  ungroup() %>% 
  mutate(source = recode(source,
                         "era" = "ERA5-Land",
                         "onf" = "ONF weather station")) %>% 
  ggplot(aes(plot, ratio, fill = position, col = position)) +
  geom_violin() +
  facet_grid(source ~ site, scales = "free_x") +
  theme_bw() +
  geom_hline(yintercept = 1) +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank()) +
  ylab("Amplitude ratio for the period 24-hr") +
  scale_y_sqrt() +
  scale_fill_manual("", values = c("#a9d9e5", "#c89867")) +
  scale_color_manual("", values = c("#a9d9e5", "#c89867"))
```

```{r buffer_summary}
#| message: false
#| warning: false
#| fig-cap: The mean amplitude ratio per sensor for the 24-hour period between May and September from 2020 to 2023 for air and soil sensors in the Mormal, Blois and Aigoual forests, for ONF and ERA5-Land macroclimate data.
buffers %>% 
  group_by(plot, position, source) %>% 
  filter(n() > 107) %>%
  ungroup() %>% 
  mutate(source = recode(source,
                         "era" = "ERA5-Land",
                         "onf" = "ONF weather station")) %>% 
  ggplot(aes(position, ratio, fill = site)) +
  geom_boxplot() +
  theme_bw() +
  coord_flip() +
  ylab("Mean amplitude ratio per sensor for the period 24-hr") +
  xlab("") +
  scale_y_sqrt() +
  facet_wrap(~ source) +
  scale_fill_discrete("")
```

```{r power24_vs_mean}
#| message: false
#| warning: false
#| fig-cap: Mean temperature vs. 24-h amplitude ratios of HOBO microclimate sensors against ONF weather station for air and soil sensors at Aigoual, Blois and Mormal forests. The point represents the median, the thick line the 50 percent distribution and the thine line the 90 percent distribution.
read_tsv("data/decomposition.tsv") %>% 
  filter(source != "era") %>% 
  filter(period %in% c(0,12)) %>% 
  pivot_wider(names_from = source, values_from = power) %>% 
  select(-coefficient, -frequency) %>% 
  na.omit() %>% 
  mutate(ratio = hobo/onf) %>% 
  select(-hobo, -onf) %>% 
  mutate(period = paste0("period_", period)) %>% 
  group_by(position, site, period) %>% 
  summarise(q05 = quantile(ratio, .05),
            q25 = quantile(ratio, .25),
            q5 = quantile(ratio, .5),
            q75 = quantile(ratio, .75),
            q95 = quantile(ratio, .95)) %>% 
  gather(metric, value, -position, -site, -period) %>% 
  mutate(period_metric = paste0(period, "_", metric)) %>% 
  select(-period, -metric) %>% 
  pivot_wider(names_from = period_metric, values_from = value) %>% 
  ggplot(aes(period_0_q5, period_12_q5, col = position)) +
  geom_vline(xintercept = 1, col = "darkgrey") +
  geom_hline(yintercept = 1, col = "darkgrey") +
  geom_segment(aes(x = period_0_q25, xend = period_0_q75)) +
  geom_segment(aes(x = period_0_q05, xend = period_0_q95), linewidth = .2) +
  geom_segment(aes(y = period_12_q25, yend = period_12_q75)) +
  geom_segment(aes(y = period_12_q05, yend = period_12_q95), linewidth = .2) +
  geom_point() +
  theme_bw() +
  ggrepel::geom_text_repel(aes(label = site), col = "black") +
  scale_color_manual("", values = c("#a9d9e5", "#c89867")) +
  xlab("Mean temperature ratio") +
  ylab("24-h amplitude ratio")
```

## Vegetation

Then we can easily establish the relationship between the plant area index and the air temperature in Blois and Mormal.

```{r pai}
#| message: false
#| warning: false
#| fig-height: 8
#| fig-cap: The relationship between the mean amplitude ratio per sensor over the 24-hour period between May and September from 2020 to 2023 for air and soil sensors, and the plot area index in the Mormal, Blois and Aigoual forests.
buffers %>% 
  group_by(plot, position, source) %>% 
  filter(n() > 107) %>%
  ungroup() %>% 
  group_by(source, site, plot, sensor, position, pai) %>% 
  summarise(ratio = mean(ratio, na.rm = TRUE)) %>% 
  mutate(source = recode(source,
                         "era" = "ERA5-Land",
                         "onf" = "ONF weather station")) %>% 
  ggplot(aes(pai, ratio, col = site)) +
  geom_point() +
  theme_bw() +
  geom_smooth(method = "lm") +
  ggpubr::stat_regline_equation(
    aes(label =  paste(..eq.label.., ..adj.rr.label.., sep = "~~~~")),
  ) +
  theme(legend.position = "bottom") +
  xlab("Plant Area Index") +
  ylab("Mean Amplitude ratio for period 24-hr") +
  scale_color_discrete("") +
  facet_grid(position ~ source)
```

## Projections & frequencies

> Add here different projections for a given time period with mean signal, 24-hr harmonics and residual variation.
