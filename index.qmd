---
title: "IMPRINT"
author: "Sylvain Schmitt, Erwan Hingant, Jonathan Lenoir"
date: last-modified
format: 
  html:
    embed-resources: true
    toc: true
    code-fold: true
bibliography: references.bib
---

```{r set}
#| message: false
# devtools::install_github("sylvainschmitt/miroclimr")
library(tidyverse)
library(dataverse)
library(microclimr)
```

# Data

We downloaded back the data from the IMPRINT project [@gril2024] using the INDORES dataverse and the R dataverse package. Additionally macroclimatic data were retrieved from ERA5-Land [@mu√±oz-sabater2021] using the Google Earth Engine (`data/get_era.py` script).

```{r dataverse}
#| eval: false
plots <- list(
  Aigoual = "10.48579/PRO/RSBT3C/VDNSLZ",
  Blois = "10.48579/PRO/RSBT3C/37MKWL",
  Mormal = "10.48579/PRO/RSBT3C/IJAKFT"
) %>% lapply(get_dataframe_by_doi, server = "data.indores.fr") %>% 
  bind_rows(.id = "site")
write_tsv(plots, "data/plots.tsv")
plots %>% 
  group_by(site) %>% 
  summarise(lon = mean(longwgs84), lat = mean(latwgs84)) %>% 
  write_tsv("data/coords.tsv")
temperatures <- list(
  Aigoual = "10.48579/PRO/ZQBQUW/MK2F35",
  Blois = "10.48579/PRO/ZQBQUW/ZL0LOC",
  Mormal = "10.48579/PRO/ZQBQUW/GBVNRR"
) %>% lapply(get_dataframe_by_doi, server = "data.indores.fr") %>% 
  bind_rows(.id = "site")
write_tsv(temperatures, "data/hobo.tsv")
lidar <- list(
  Aigoual = "10.48579/PRO/XH62TC/P4F7FP",
  Blois = "10.48579/PRO/XH62TC/OI6WQU",
  Mormal = "10.48579/PRO/XH62TC/5RXUGU"
) %>% lapply(get_dataframe_by_doi, server = "data.indores.fr") %>% 
  bind_rows(.id = "site")
write_tsv(lidar, "data/lidar.tsv")
era <- read_tsv("data/era.tsv") %>% 
  mutate(site = recode(dim_0, "0" = "Aigoual", "1" = "Blois", "2" = "Mormal")) %>% 
  mutate(datetime = as_datetime(time)) %>% 
  rename(era = tas) %>% 
  select(site, datetime, era)
lidar_sub <- lidar %>% 
  filter(buffer == 5) %>% 
  rename(plot = idplot) %>% 
  select(site, plot, pai)
data <- temperatures %>% 
  mutate(datetime = as_datetime(datetime)) %>% 
  rename(hobo = t_hobo, plot = id_plot, sensor = id_sensor,
         position = position_sensor) %>% 
  mutate(position = recode(position, "a" = "air", "s" = "soil")) %>% 
  select(site, plot, sensor, position, datetime, hobo) %>% 
  left_join(era) %>% 
  left_join(lidar_sub)
write_tsv(data, "data/data.tsv")
```

## Decomposition

We decomposed all the temperature series for ERA5-Land and HOBOs in May to September for each plot and sensor on 5 days window sliding of 3 days using a single call to `microclimr::fft_roll` (ca. 1 minute):

```{r decomposition}
#| eval: false
data <- read_tsv("data/data.tsv")
fc <- data %>%
  filter(month(datetime) %in% 5:9) %>% 
  gather(source, temperature,
         -site, -plot, -sensor, -position, -datetime, -pai) %>% 
  group_by(source, site, plot, sensor, position, pai,
           datetime = floor_date(datetime, "2 hour")) %>%
  summarise(temperature = mean(temperature)) %>% 
    group_by(source, site, plot, sensor, position, pai) %>%
  do(fft = fft_roll(
    data = .,
    t = 5*12,
    index_col = "datetime",
    temperature_col = "temperature",
    window = "5 days",
    step = "3 days"
  )) %>%
  unnest(fft)
write_tsv(fc, "data/decomposition.tsv")
```

> We summarised the temperature data at a frequency of two hours to homogenise soil and air temperature sensors, but we could use different time frequencies in the future.

## Buffer

We can compute back the amplitude buffer at a period of 24h.

```{r buffer}
#| message: false
#| warning: false
#| fig-cap: The amplitude ratio for the 24-hour period between May and September from 2020 to 2023 for air and soil sensors in the Mormal, Blois and Aigoual forests.
read_tsv("data/decomposition.tsv") %>% 
  filter(period == 12) %>% 
  select(source, site, plot, sensor, position, pai, power, datetime) %>% 
  pivot_wider(names_from = source, values_from = power) %>% 
  mutate(ratio = hobo/era) %>% 
  ggplot(aes(plot, ratio, fill = position, col = position)) +
  geom_violin() +
  facet_wrap(~ site, nrow = 3, scales = "free_x") +
  theme_bw() +
  scale_fill_discrete(guide = "none") +
  scale_color_discrete(guide = "none") +
  geom_hline(yintercept = 1) +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank()) +
  ylab("Amplitude ratio for the period 24-hr") +
  scale_y_sqrt()
```

```{r buffer_summary}
#| message: false
#| warning: false
#| fig-cap: The mean amplitude ratio per sensor for the 24-hour period between May and September from 2020 to 2023 for air and soil sensors in the Mormal, Blois and Aigoual forests.
read_tsv("data/decomposition.tsv") %>% 
  filter(period == 12) %>% 
  select(source, site, plot, sensor, position, pai, power, datetime) %>% 
  pivot_wider(names_from = source, values_from = power) %>% 
  mutate(ratio = hobo/era) %>% 
  group_by(site, plot, sensor, position, pai) %>% 
  summarise(ratio = mean(ratio)) %>% 
  group_by(position, site) %>% 
  ggplot(aes(position, ratio, fill = site)) +
  geom_boxplot() +
  theme_bw() +
  coord_flip() +
  ylab("Mean amplitude ratio per sensor for the period 24-hr") +
  xlab("") +
  scale_y_sqrt()
```

## Vegetation

Then we can easily find the relationship with the plant area index:

```{r pai}
#| message: false
#| warning: false
#| fig-cap: The relationship between the mean amplitude ratio per sensor over the 24-hour period between May and September from 2020 to 2023 for air and soil sensors, and the plot area index in the Mormal, Blois and Aigoual forests.
read_tsv("data/decomposition.tsv") %>% 
  filter(period == 12) %>% 
  select(source, site, plot, sensor, position, pai, power, datetime) %>% 
  pivot_wider(names_from = source, values_from = power) %>% 
  mutate(ratio = hobo/era) %>% 
  group_by(site, plot, sensor, position, pai) %>% 
  summarise(ratio = mean(ratio)) %>% 
  ggplot(aes(pai, ratio, col = site)) +
  geom_point() +
  theme_bw() +
  geom_smooth(method = "lm") +
  ggpubr::stat_regline_equation(
    aes(label =  paste(..eq.label.., ..adj.rr.label.., sep = "~~~~")),
  ) +
  theme(legend.position = "bottom") +
  xlab("Plant Area Index") +
  ylab("Mean Amplitude ratio for period 24-hr") +
  scale_color_discrete("Site") +
  facet_wrap(~ position)
```
